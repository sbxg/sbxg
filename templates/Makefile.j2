# Copyright (c) 2017 Jean Guyomarc'h
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
# THE SOFTWARE.

# This is a generated file.

.PHONY: all

all: {% if kernel %}kernel{% endif %} {%if uboot %}uboot{% endif %} {% if busybox %}busybox{% endif %}

#==============================================================================#
#                                Kernel Targets                                #
#==============================================================================#
{% if kernel %}
linux-make-helper = \
	$(MAKE) \
	ARCH="{{ toolchain.arch }}" \
	CROSS_COMPILE="{{ toolchain.path }}/{{ toolchain.prefix }}" \
	O=$(3) \
	-C $(2) \
        $(1)

{% if kernel.type == "linux" %}
.PHONY: linux linux-%

linux-%:
	+$(call linux-make-helper,$(patsubst linux-%,%,$@),"{{ kernel.path }}","{{ kernel.build_dir }}")

linux:
	@echo "[SBXG/kernel] Building Linux kernel"
	+$(call linux-make-helper,all,"{{ kernel.path }}","{{ kernel.build_dir }}")
{% endif %}

{% if xen %}

xen-make-helper = \
	$(MAKE) \
	CROSS_COMPILE="{{ toolchain.path }}/{{ toolchain.prefix }}" \
	XEN_TARGET_ARCH="{{ board.xen_arch }}" \
	-C "{{ xen.path }}/xen" \
	$(1)


.PHONY: xen xen-%

xen-%:
	+$(call xen-make-helper,$(patsubst xen-%,%,$@))

xen:
	@echo "[SBXG/kernel] Building Xen kernel"
	+$(call xen-make-helper,xen)

{% if guests -%}
.PHONY: guests

{%- for guest in guests %}
.PHONY: guest-{{ loop.index0 }}-%

guest-{{ loop.index0 }}-%:
	+$(call {{ guest.kernel.type }}-make-helper,$(patsubst guest-{{ loop.index0 }}-%,%,$@),{{ guest.kernel.path }},{{ guest.kernel.build_dir }})
{% endfor %}

guests:
	{%- for guest in guests %}
	@echo "[SBXG/guests] Building guest {{ loop.index0 }}: {{ guest.kernel.name }}"
	+$(MAKE) guest-{{ loop.index0 }}-zImage
	{%- endfor %}
{% endif %}

{% endif %}{# End of xen #}

.PHONY: kernel

kernel: {{ kernel.type }} {% if xen %}xen{% endif %}

{% else %}
# No kernel specified when bootstrapping...
{% endif %}


#==============================================================================#
#                                U-Boot Targets                                #
#==============================================================================#
{% if uboot %}

uboot-make-helper = \
	$(MAKE) \
	CROSS_COMPILE={{ toolchain.path }}/{{ toolchain.prefix }} \
	O={{ uboot.build_dir }} \
	-C {{ uboot.path }} \
	$(1)

.PHONY: uboot uboot-%

uboot-%:
	+$(call uboot-make-helper,$(patsubst uboot-%,%,$@))

uboot:
	@echo "[SBXG/uboot] Building u-boot"
	+$(call uboot-make-helper,all)

{% else %}
# No u-boot specified when bootstrapping...
{% endif %}

#==============================================================================#
#                                Busybox Targets                               #
#==============================================================================#
{% if busybox %}
.PHONY: busybox busybox-%

busybox-make-helper = \
	$(MAKE) \
	ARCH="{{ toolchain.arch }}" \
	O="{{ busybox.build_dir }}" \
	CROSS_COMPILE="{{ toolchain.path }}/{{ toolchain.prefix }}" \
	-C "{{ busybox.path }}" \
	$(1)


busybox-%:
	+$(call busybox-make-helper,$(patsubst busybox-%,%,$@))

busybox:
	@echo "[SBXG/busybox] Building busybox"
	+$(call busybox-make-helper,busybox)
	+$(call busybox-make-helper,install)
	@echo "[SBXG/busybox] Packaging busybox"
	python3 {{ top_src_dir }}/scripts/create-initramfs.py \
            --output "{{ busybox.build_dir }}/initramfs.cpio" \
	    "{{ busybox.build_dir }}"/_install


{% endif %}

#==============================================================================#
#                               Genimage Targets                               #
#==============================================================================#
{% if genimage %}

{% if guests %}
.PHONY: genimage-guests

genimage-guests: {{ genimage.build_dir }}/genimage
{%- for guest in guests %}
	@echo "[SBXG/guests] Copying image products of guest {{ loop.index0 }}"
	"{{ genimage.build_dir }}/genimage" \
		--outputpath "{{ genimage.output_path }}" \
		--inputpath "{{ genimage.input_path }}/guest{{ loop.index0 }}" \
		--rootpath "{{ genimage.root_path }}" \
		--tmppath "{{ genimage.tmp_path }}" \
		--config "{{ guest.image }}"
{% endfor %}

{% endif %}


.PHONY: genimage

genimage: {{ genimage.build_dir }}/genimage
	@echo "[SBXG/image] Copying image products"
	cp "{{ kernel.build_dir }}/arch/{{ toolchain.arch }}/boot/{{ board.linux_image }}" "{{ genimage.input_path }}"
	cp "{{ kernel.build_dir }}/arch/{{ toolchain.arch }}/boot/dts/{{ board.linux_dtb }}" "{{ genimage.input_path }}"
	cp "{{ uboot.build_dir }}/{{ board.uboot_image }}" "{{ genimage.input_path }}"
	{%- if xen %}
	cp "{{ xen.path }}/xen/{{ board.xen_image }}" "{{ genimage.input_path }}"
	{%- endif %}
	@echo "[SBXG/image] Generating boot script"
	"{{ uboot.build_dir }}/tools/mkimage" -C none -A {{ toolchain.arch }} -T script -d "{{ top_build_dir }}/boot.cmd" "{{ genimage.input_path }}/{{ board.boot_script }}"

	MTOOLS_SKIP_CHECK=1 "{{ genimage.build_dir }}/genimage" \
		--outputpath "{{ genimage.output_path }}" \
		--inputpath "{{ genimage.input_path }}" \
		--rootpath "{{ genimage.root_path }}" \
		--tmppath "{{ genimage.tmp_path }}" \
		--config "{{ genimage.config }}"

{{ genimage.build_dir }}/genimage:
	@echo "[SBXG/image] Building genimage"
	mkdir -p {{ genimage.build_dir }}
	cd "{{ genimage.path }}" && autoreconf -is
	cd "{{ genimage.build_dir }}" && "{{ genimage.path }}/configure"
	+$(MAKE) -C "{{ genimage.build_dir }}"

{% else %}
# Image generation was not specified when bootstrapping...
{% endif %}

.PHONY: help

help:
	@echo "============= SBXG Build Targets ============="
	@echo
	@echo "all           build all available targets"
	{%- if uboot %}
	@echo "uboot         build the bootloader"
	@echo "uboot-<cmd>   run the <cmd> target in u-boot"
	{%- endif %}
	{%- if kernel %}
	@echo "kernel        build the kernel"
	  {%- if kernel.type == "linux" %}
	@echo "linux-<cmd>   run the <cmd> target in linux"
	  {%- endif %}
	{%- endif %}
        {%- if busybox %}
	@echo "busybox       build busybox"
	@echo "busybox-<cmd> run the <cmd> target in busybox"
        {%- endif %}

	{%- if genimage %}
	@echo "genimage      compile and execute genimage"
	{%- endif %}

