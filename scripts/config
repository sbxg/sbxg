# Copyright (c) 2016, Jean Guyomarc'h <jean@guyomarch.bzh>
#
# This file is part of SBXG
#
# SBXG is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# SBXG is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with SBXG.  If not, see <http://www.gnu.org/licenses/>.


#========
# This file aims at beeing sourced by all shell sripts.
# It is a helper to source the real configuration files, and
# properly handle errors.
#========

# Get the top source directory
TOP_SOURCE_DIR="$(dirname "$0")"/..

# Default log file
LOG_FILE="sbxg_$(basename "$0").log"

# Source .config if it exists, otherwise throws an error
MAIN_CONFIG_PATH="$TOP_SOURCE_DIR"/.config
if [ ! -e "$MAIN_CONFIG_PATH" ]; then
   echo "*** Failed to find $(realpath "$MAIN_CONFIG_PATH")" 1>&2
   echo "*** Did you run 'make menuconfig'?" 1>&2
   exit 127
fi
. "$MAIN_CONFIG_PATH"


# Copy stdout and stderr to a log file
if [ "x$CONFIG_DEBUG_SBXG" = "xy" ]; then
   exec > >(tee -i "$LOG_FILE")
   exec 2>&1
fi

# Source board config if it exists, otherwise throws an error
BOARD_CONFIG_PATH="$TOP_SOURCE_DIR"/"$CONFIG_BOARDS_DIR"/"$CONFIG_BOARD".conf
if [ ! -e "$BOARD_CONFIG_PATH" ]; then
   echo "*** Failed to find $(realpath "$BOARD_CONFIG_PATH")" 1>&2
   echo "*** Did you run 'make init'?" 1>&2
   exit 127
fi
. "$BOARD_CONFIG_PATH"

# Don't keep around variables used in this file
unset MAIN_CONFIG_PATH
unset BOARD_CONFIG_PATH
unset TOP_SOURCE_DIR
unset LOG_FILE
